 <!DOCTYPE html>
<html>
	<head>
		<title>Sand Game</title>
		<meta charset="UTF-8">
		<meta name="author" content="Ian Vamossy">
		<link rel="stylesheet" type="text/css" href="style.css">
	</head>
	
	<body>
		<h1>Ian Vamossy - Welcome to Vamossy.com</h1>
		<h2>Powder Game HTML5 Clone (WIP)</h2>
		
		<div id="canvas-container">
			<canvas id="myCanvas" width="800" height="600">Your browser does not support HTML5. Please update to a more modern browser.</canvas>
		</div>

		<script src="scripts/stats.min.js"></script>

		<script>
			var canvas = document.getElementById("myCanvas");
			var context = canvas.getContext("2d");
			var stats = new Stats();
			stats.setMode(0); // 0: fps, 1: ms

			// Align top-left
			stats.domElement.style.position = 'absolute';
			stats.domElement.style.left = '0px';
			stats.domElement.style.top = '0px';

			document.body.appendChild( stats.domElement );

			setInterval( function () {

				stats.begin();

				context.fillStyle = '#000000';
				context.fillRect(0, 0, canvas.width, canvas.height);
				
				var GRAVITY = 4;

				var sand = {
					width: 2,
					height: 2
				};

				window.requestAnimFrame = (function(callback) {
					return window.requestAnimationFrame || window.webkitRequestAnimationFrame || window.mozRequestAnimationFrame || window.oRequestAnimationFrame || window.msRequestAnimationFrame ||
					function(callback) {
						window.setTimeout(callback, 1000 / 60);
					};
				})();

				function getMousePos(canvas, evt) {
					var rect = canvas.getBoundingClientRect();
					return {
						x: evt.clientX - rect.left,
						y: evt.clientY - rect.top
					};
				}

				function drawSand(sand, context, posX, posY) {
					context.beginPath();
					context.rect(posX, posY, sand.width, sand.height);
					context.fillStyle = '#ffffff';
					context.fill();

					//context.fillRect(sand.x, sand.y, sand.width, sand.height);
					//context.fillStyle = '#000000';
				}

				function createSand(e){
					var mousePos = getMousePos(canvas, e);

					//First draw of sand rectangle
					drawSand(sand, context, mousePos.x, mousePos.y);

					//canvas.addEventListener('mousemove', createSand, false);

					var startTime = (new Date()).getTime();
					animate(sand, canvas, context, startTime, mousePos.x, mousePos.y);
				}

				//Add sand event listener
				canvas.addEventListener('mousedown', createSand, false);

				function animate(sand, canvas, context, startTime, posX, posY) {
					// update elapsed time
					var time = (new Date()).getTime() - startTime;

					// pixels / second
					var linearSpeed = GRAVITY;

					var originalY = posY;
					var newY = (linearSpeed * time / 1000);

					if(newY < canvas.height - sand.height) {
						posY = originalY + newY;
					}

					// clear
					context.fillStyle = '#000000';
					context.fillRect(0, 0, canvas.width, canvas.height);

					//Redraw sand every animation frame, reset startTime
					drawSand(sand, context, posX, originalY + newY);

					// request new frame
					requestAnimFrame(function() {
						animate(sand, canvas, context, startTime, false);
					});
				}

				stats.end();

			}, 1000 / 60 );
		</script>
	</body>
</html>

